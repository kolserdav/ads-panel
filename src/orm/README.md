## Импровизированная ORM

В папке orm располагаются файлы index.ts в одноименных с папками роутов дирректориями. В каждом файле набор методов. Для разбивки по именованым объектам используется файл `orm/index.ts`.
В самом начале я пытался использовать готовую orm `typeorm`, но у меня не было опыта работы с ней, времени было мало, а первые впечатления оказались противоречивыми. Поэтому я решил использовать `mysql2` - он низкоуровневый по сравнению с `typeorm`. Сразу не стал изобретать своё orm, а придерживался api `mysql2` для максимальной простоты и наглядности. В большистве методов используется один вариант простого запроса, так мне показалось наглядней и безопасней. 
```javascript
/**
 * Создание нового оффера
 * @param offer 
 */
export function createNew(offer: Types.Offer): Promise<Types.OrmResult> {
  return new Promise(resolve => {
    connection.query(
      'INSERT INTO `offers` (user_id, title, description) VALUES (?,?,?)',
      [
        offer.user_id,
        offer.title,
        offer.description,
      ],
      (err, results, fields) => {
        if (err) {
          console.error(`<${Date()}>`, '[Error create new offer]', err);
          resolve({
            error: 1,
            data: err.message,
          });
        }
        resolve({
          error: 0,
          data: results,
        });
      },
    );
  });
}
``` 
Но с началом разработки `statistics/index.ts` оказалось, что количество параметров фильтров и группировок, при преждем подходе, плодит безумное количество клонов. Поэтому orm метод статистики пришлось немного усложнить и сделать универсальней. В ходе этого стало очевидным, что предыдущий подход, в некоторых местах, имеет места, которые можно оптимизировать с точки зрения, читаемости и удобства в работе с кодом путём переиспользования. Надеюсь это не вызовет проблем. Но на всякий случай помечаю всё как DEPRECATED. Чтобы в будущем стараться перекидывать логику на orm вместо роутов. Пример усложненной логики в роуте `routes/campaign/get.campaigns.ts` демонстрирует эту проблему. 

19.11.2020 02:07